@model Ecommerce.Models.Produto

@{
    ViewData["Title"] = Model.NomeProduto;

    
    var avaliacoes = ViewBag.Avaliacoes as List<Ecommerce.Models.Avaliacao>;
    
    var clienteIdLogado = Context.Session.GetInt32("ClienteId");
   
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="~/css/style.css"> 
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<div class="container mt-5">
    <div class="row">
        <div class="col-md-6">
            <img src="@(string.IsNullOrEmpty(Model.ImagemUrl) ? "/images/placeholder.jpg" : Model.ImagemUrl)" 
                 class="img-fluid rounded" alt="@Model.NomeProduto">
        </div>

        <div class="col-md-6">
            
            <h2>@Model.NomeProduto</h2>
            
            <p class="lead">@Model.Descricao</p>

            <div class="product-stars mb-3" style="color: #FFD700;">
                <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star-half-alt"></i>
            </div>

            <h3 style="color: var(--cor-verde-floresta);">R$ @Model.Preco.ToString("F2")</h3>

            <p class="in_stock">Estoque: @Model.Estoque unidades</p>
            
            <hr>

            <form asp-controller="Carrinho" asp-action="Adicionar" method="post" class="mt-3">
                <input type="hidden" name="id" value="@Model.IdProduto" /> 
                
                <div class="row align-items-end">
                    
                    <div class="col-md-3 col-5">
                        <label for="qtd" class="form-label">Quantidade:</label>
                        <input type="number" name="qtd" value="1" min="1" class="form-control form-control-lg" />
                    </div>

                    <div class="col-md-9 col-7">
                        <button type="submit" class="btn btn-outline-success btn-lg w-100"> 
                            <i class="fa fa-shopping-cart"></i> Adicionar ao carrinho
                        </button>
                    </div>

                </div>
            </form>
            
            <a href="javascript:history.back()" class="btn btn-dark btn-lg w-100 mt-2">Voltar</a>
        </div>
        </div>

    <hr class="mt-5 mb-4">

    <div class="row">
        <div class="col-md-7">
            <h3>Avaliações de Clientes (@avaliacoes.Count)</h3>
            
            @if (avaliacoes.Count == 0)
            {
                <p>Este produto ainda não foi avaliado. Seja o primeiro!</p>
            }
            else
            {
                <table class="table table-borderless table-striped">
                    <tbody>
                    @foreach(var avaliacao in avaliacoes)
                    {
                        <tr>
                            <td>
                                <strong>@avaliacao.NomeCliente</strong>
                                <span class="text-muted small"> - @avaliacao.DataAvaliacao.ToShortDateString()</span>
                                
                                <div class="product-stars" style="color: #FFD700; font-size: 0.9em;">
                                    @for (int i = 0; i < avaliacao.Nota; i++) { <i class="fa fa-star"></i> }
                                    @for (int i = avaliacao.Nota; i < 5; i++) { <i class="far fa-star" style="color: #ccc;"></i> }
                                </div>
                                
                                <p class="mt-2">@avaliacao.Comentario</p>
                            </td>
                            
                            <td class="text-end align-middle" style="min-width: 180px;">
                                @if (avaliacao.ClienteId == clienteIdLogado)
                                {
                                    <a href="/avaliacao/update/@Model.IdProduto" class="btn btn-sm btn-warning">Editar</a>
                                    <a href="/avaliacao/delete/@Model.IdProduto" class="btn btn-sm btn-danger">Apagar</a>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            }
        </div>

        <div class="col-md-5">
            @if (clienteIdLogado != null)
            {
                // Verifica se o cliente logado já avaliou este produto
                var clienteJaAvaliou = avaliacoes.Any(a => a.ClienteId == clienteIdLogado);

                if (!clienteJaAvaliou)
                {
                    <h3>Deixe sua avaliação</h3>
                    <form action="/avaliacao/create" method="POST">
                        <input type="hidden" name="ProdutoId" value="@Model.IdProduto" />
                        
                        <div class="mb-3">
                            <label for="Nota" class="form-label">Nota (1 a 5):</label>
                            <input name="Nota" type="number" min="1" max="5" value="5" class="form-control" required />
                        </div>
                        
                        <div class="mb-3">
                            <label for="Texto" class="form-label">Comentário:</label>
                            <textarea name="Comentario" class="form-control" rows="4" placeholder="Conte-nos o que achou do produto..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-outline-success w-100">Enviar Avaliação</button>
                    </form>
                }
                else
                {
                    <div class="alert alert-info">Você já avaliou este produto.</div>
                }
            }
            else
            {
                <div class="alert alert-secondary">
                    <a href="/Cliente/Login">Faça login</a> para deixar uma avaliação.
                </div>
            }
        </div>
    </div>
    </div>