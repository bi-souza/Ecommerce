@model List<Ecommerce.Models.Produto>

<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    </head>

    @{        
        var deleteErrorMessage = TempData["DeleteError"]?.ToString();
     }

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">


    <br />
    <a a asp-controller="Admin" asp-action="Dashboard" 
        class="btn btn-voltar-custom mb-3">
            ← Voltar
        </a>

    @*<div class="container mt-3">*@
    @*<body class="container-fluid">*@
        <h1>Gerenciamento de Produtos</h1>
        <p>Total de produtos: @Model.Count</p>

        <a class="btn btn-outline-success mb-3" href="/produto/create">Adicionar Novo Produto</a>

        <table class="table table-hover table-striped">
            <thead class="table-success">
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Preço</th>
                    <th>Estoque</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach(var produto in Model) {
                <tr>
                    <td>@produto.IdProduto</td>
                    <td>@produto.NomeProduto</td>
                    <td>@produto.Preco.ToString("C")</td>
                    <td>@produto.Estoque</td>
                    <td>
                        <a class="btn btn-sm btn-outline-warning" href="/produto/update/@produto.IdProduto">
                            <i class="fas fa-edit"></i> Editar                            
                        </a>

                        @* AJUSTE: Botão APAGAR para abrir o modal *@
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            data-bs-toggle="modal" 
                            data-bs-target="#modalConfirmacaoExclusao"
                            data-id="@produto.IdProduto"
                            data-nome="@produto.NomeProduto" 
                            title="Apagar">
                        <i class="fas fa-trash-alt"></i> Apagar
                    </button>
                </td>
            </tr>
            }
        </tbody>
    </table>
    
   
    <div class="modal fade" id="modalConfirmacaoExclusao" tabindex="-1" aria-labelledby="modalConfirmacaoExclusaoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfirmacaoExclusaoLabel">Confirmação de Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                
                <form asp-controller="Produto" asp-action="Delete" method="POST">
                    <div class="modal-body">
                        @* ID OCULTO: ID genérico para Produto *@
                        <input type="hidden" name="id" id="produtoIdExclusao" value="" />
                        
                        <p>Você tem certeza que deseja excluir o produto: <strong><span id="produtoNomeExclusao"></span></strong>?</p>
                        @*<p class="text-danger mt-3">Esta ação é irreversível.</p>*@
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Sim, Excluir!</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    @* FIM DA ESTRUTURA DO MODAL *@

    <div class="modal fade" id="statusMessageModal" tabindex="-1" aria-labelledby="statusMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"> 
                    <h5 class="modal-title" id="statusMessageModalLabel">Operação Não Permitida</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> 
                </div>
                <div class="modal-body">
                    <p id="statusMessageText"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>


    @section Scripts 
    {
        <script>
            // O JavaScript foi ajustado para usar os novos IDs: #produtoIdExclusao e #produtoNomeExclusao
            var modalExclusao = document.getElementById('modalConfirmacaoExclusao');
            modalExclusao.addEventListener('show.bs.modal', function (event) {
                
                var button = event.relatedTarget;
                
                // Extrai as informações dos atributos data-* do botão (data-id e data-nome)
                var itemId = button.getAttribute('data-id');
                var itemNome = button.getAttribute('data-nome');

                // Atualiza os campos dentro do modal usando os IDs ESPECÍFICOS da View de Produto
                var modalInputId = modalExclusao.querySelector('#produtoIdExclusao');
                var modalSpanNome = modalExclusao.querySelector('#produtoNomeExclusao');

                // Injeta os valores
                modalInputId.value = itemId;
                modalSpanNome.textContent = itemNome;
            });

            @if (!string.IsNullOrEmpty(deleteErrorMessage))
            {
                <text>
                    // 1. Encontra o elemento de texto dentro do novo modal
                    var messageTextElement = document.getElementById('statusMessageText');
                    
                    // 2. CORREÇÃO CRÍTICA: O uso de @Html.Raw(deleteErrorMessage)
                    // impede que o Razor codifique a string C# em HTML, permitindo que os
                    // caracteres especiais sejam passados corretamente para o JavaScript.
                    messageTextElement.textContent = '@Html.Raw(deleteErrorMessage)';

                    // 3. Cria uma instância do modal do Bootstrap
                    var statusModal = new bootstrap.Modal(document.getElementById('statusMessageModal'));
                    
                    // 4. Exibe o modal
                    statusModal.show();
                </text>
            }
        </script>
        
        @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    }
</html>