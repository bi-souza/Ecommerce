@model List<Ecommerce.Models.Categoria>

@{
    ViewData["Title"] = "Gerenciamento de Categorias";
    Layout = "_Layout";
}

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">


    <br />
    <a asp-controller="Admin" asp-action="Dashboard"
        class="btn btn-voltar-custom mb-3">
            ← Voltar
        </a>


@*<div class="container mt-4">*@

    <h1 class="text-dark">Gerenciamento de Categorias</h1>
    <p>Total de categorias: @Model.Count</p>

    @{        
        
        var mensagemErro = TempData["MensagemErro"] as string;
    }

    
    <a class="btn btn-outline-success mb-3" asp-controller="Categoria" asp-action="Create">
        <i class="fas fa-plus"></i> Adicionar Nova Categoria
    </a>

    <table class="table table-hover table-striped">
        <thead class="table-success">
            <tr>
                <th>ID</th>
                <th>Nome da Categoria</th>
                <th style="width: 250px;">Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach(var categoria in Model) {
            <tr>
                <td>@categoria.IdCategoria</td>
                <td>@categoria.NomeCategoria</td>
                <td>
                    <div class="d-flex justify-content-start align-items-center gap-2">
                    <a class="btn btn-sm btn-outline-warning" asp-controller="Categoria" asp-action="Update" asp-route-id="@categoria.IdCategoria" title="Editar">
                        <i class="fas fa-edit"></i> Editar
                    </a>

                    
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            data-bs-toggle="modal" 
                            data-bs-target="#modalConfirmacaoExclusao"
                            data-id="@categoria.IdCategoria"
                            data-nome="@categoria.NomeCategoria"
                            title="Apagar">
                        <i class="fas fa-trash-alt"></i> Apagar
                    </button>

                    <a class="btn btn-sm btn-outline-success" asp-controller="Produto" asp-action="Create" title="Adicionar Produto">
                        <i class="fa-regular fa-square-plus"></i> 
                    </a>

                    
                </td>
            </tr>
            }
        </tbody>
    </table>
    <div class="modal fade" id="modalConfirmacaoExclusao" tabindex="-1" aria-labelledby="modalConfirmacaoExclusaoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfirmacaoExclusaoLabel">Confirmação de Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form asp-controller="Categoria" asp-action="Delete" method="POST">
                    <div class="modal-body">
                        @* ID OCULTO: Será preenchido via JavaScript *@
                        <input type="hidden" name="id" id="categoriaIdExclusao" value="" />
                        
                        <p>Você tem certeza que deseja excluir a categoria: <strong><span id="categoriaNomeExclusao"></span></strong>?</p>
                        @*<p class="mb-0"><strong>Nome: <span id="categoriaNomeExclusao"></span></strong></p>*@
                        @*<p class="text-danger mt-3">Esta ação é irreversível.</p>*@
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Sim, Excluir!</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFeedback" tabindex="-1" aria-labelledby="modalFeedbackLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">                    
                    <h5 class="modal-title" id="modalFeedbackLabel"></h5> 
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="feedbackMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

@section Scripts {
    <script>
        // Quando o modal está prestes a ser mostrado
        var modalExclusao = document.getElementById('modalConfirmacaoExclusao');
        modalExclusao.addEventListener('show.bs.modal', function (event) {
            
            // Botão que disparou o modal
            var button = event.relatedTarget;
            
            // Extrai as informações dos atributos data-* do botão
            var categoriaId = button.getAttribute('data-id');
            var categoriaNome = button.getAttribute('data-nome');

            // Atualiza os campos dentro do modal
            var modalInputId = modalExclusao.querySelector('#categoriaIdExclusao');
            var modalSpanNome = modalExclusao.querySelector('#categoriaNomeExclusao');

            // Injeta os valores
            modalInputId.value = categoriaId;
            modalSpanNome.textContent = categoriaNome;
        });

        const erro = '@Html.Raw(mensagemErro)';
        
        const modalFeedback = document.getElementById('modalFeedback');
        
        // 2. Verifica se a string de erro existe e não está vazia (após o trim)
        if (erro && erro.trim() !== '') {
            const modalBody = modalFeedback.querySelector('#feedbackMessage');
            
            // Preenche o conteúdo do modal de erro
            modalBody.innerHTML = `
                <p class="text-dark">${erro}</p>
                <p class="mt-3">A exclusão foi impedida para proteger a integridade dos seus dados. Esta categoria possui produtos vinculados. Remova os vínculos e tente novamente.</p>
            `;
            
            // 3. Cria uma instância do Modal do Bootstrap e o exibe imediatamente
            // Assume-se que a biblioteca Bootstrap 5 (ou superior) está linkada no _Layout.
            const feedbackModal = new bootstrap.Modal(modalFeedback);
            feedbackModal.show();
        }
    </script>
    
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}